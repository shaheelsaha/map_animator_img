<!DOCTYPE html>
<!-- saved from url=(0054)https://chrisboligprojects.pythonanywhere.com/gpuEarth -->
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Vertex Earth Interactive</title>

    <!-- Three.js Import Map (REQUIRED) -->


    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Mapbox Geocoder -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">

    <style>
        /* Specific Z-Indexing for stacking context stability */
        #geocoder-start .mapboxgl-ctrl-geocoder {
            z-index: 20;
        }

        #geocoder-end .mapboxgl-ctrl-geocoder {
            z-index: 10;
        }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.161/build/three.module.js",
          "jsm/": "https://cdn.jsdelivr.net/npm/three@0.161/examples/jsm/"
        }
      }
    </script>
  <script type="module" crossorigin src="/assets/index-AsfGBdma.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-BfCcG8cW.css">
</head>

<body>
    <!-- SEARCH UI -->
    <div id="search-overlay">
        <label>START LOCATION</label>
        <div class="timeline-step">
            <div id="geocoder-start" class="geocoder-container"></div>
            <!-- Start Connector (JS) -->
        </div>

        <div id="stops-container" style="display: flex; flex-direction: column; gap: 0px; margin-bottom: 20px;">
            <!-- Dynamic stops will be added here -->
        </div>

        <button id="add-stop-btn" class="action-btn secondary-btn" style="margin-bottom: 24px;">+ Add Stop</button>

        <div id="route-stats"
            style="color: #888; font-size: 13px; margin-top: 4px; font-weight: 500; text-align: center;"></div>

        <!-- Action Buttons -->
        <button id="start-flight-btn" class="action-btn">FLY ROUTE ‚úàÔ∏è</button>
        <button id="open-export-btn" class="action-btn">Export Video üé•</button>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" style="display: none;">
        <div class="modal-content">
            <h2>Export Settings</h2>

            <label>Resolution</label>
            <select id="export-resolution">
                <option value="480p">480p (Fastest)</option>
                <option value="720p" selected>720p (HD)</option>
                <option value="1080p">1080p (Full HD)</option>
                <option value="2k">2k (QHD)</option>
                <option value="4k">4k (UHD)</option>
            </select>

            <label>Frame Rate</label>
            <select id="export-fps">
                <option value="25">25 fps (Cinematic)</option>
                <option value="30" selected>30 fps (Standard)</option>
                <option value="60">60 fps (Smooth)</option>
            </select>

            <div class="modal-buttons">
                <button id="cancel-export-btn" class="secondary">Cancel</button>
                <button id="confirm-export-btn" class="primary">Start Export üöÄ</button>
            </div>
            <p id="export-status" style="font-size: 12px; color: #aaa; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- ERROR HANDLER -->
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            alert("Global Error: " + message + "\nLine: " + lineno);
        };
    </script>


    <script>
        // TOKEN CONFIG
        const MB_TOKEN = 'pk.eyJ1Ijoic2hhaGVlbDU1IiwiYSI6ImNta2Q0cTNqZTA2cGszZ3M2dzVucDdsOGwifQ.WGhIdum-usVYkJJZOfr9UA';
        mapboxgl.accessToken = MB_TOKEN;
        // Helper to create mode selector (Pill Style)
        function createModeSelector(id) {
            const container = document.createElement('div');
            container.className = 'timeline-connector';

            const select = document.createElement('select');
            select.id = `mode-${id}`;
            select.className = 'mode-select-pill';
            select.innerHTML = `
                <option value="flight">‚úàÔ∏è Flight</option>
                <option value="car">üöó Car</option>
                <option value="train">üöÇ Train</option>
            `;

            container.appendChild(select);
            return container;
        }

        // 1. Initialize Start Geocoder
        const geocoderStart = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            types: 'place,locality,neighborhood',
            placeholder: 'Search Start City...',
            flyTo: false
        });

        geocoderStart.addTo('#geocoder-start');
        // Add mode selector (connector) to Start container
        // We need to append it to the parent .timeline-step, not inside the geocoder itself to span the gap
        const startStep = document.getElementById('geocoder-start').parentElement;
        startStep.appendChild(createModeSelector('start'));

        // Fix Z-Index for Start
        const startContainer = document.getElementById('geocoder-start');
        startContainer.addEventListener('focusin', () => {
            startContainer.classList.add('active-z');
        });
        startContainer.addEventListener('focusout', () => {
            setTimeout(() => {
                startContainer.classList.remove('active-z');
            }, 200);
        });

        geocoderStart.on('result', (e) => {
            console.log('Start Selected:', e.result);
            startCoords = e.result.center; // [lng, lat]

            // Store globally for export
            window.startCoords = startCoords;

            // Add Marker
            if (window.addMapMarker) {
                // window.clearMapMarkers(); // Optional: Clear previous if only single route focused
                window.addMapMarker(startCoords[1], startCoords[0], 'start');
            }
        });

        // 2. (Destination removed - last stop is the destination)

        // 3. Handle Add Stop Button
        const stopsContainer = document.getElementById('stops-container');
        const stopData = {}; // Object to store data by ID
        let stopCounter = 0; // Always incrementing counter for unique IDs

        document.getElementById('add-stop-btn').addEventListener('click', () => {
            const currentId = stopCounter++;
            const stopId = `stop-${currentId}`;
            const stopDiv = document.createElement('div');
            stopDiv.className = 'geocoder-container timeline-step';
            stopDiv.id = stopId;
            stopDiv.style.marginBottom = '20px';
            stopsContainer.appendChild(stopDiv);

            const geocoderStop = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                types: 'place,locality,neighborhood',
                placeholder: `Stop ${currentId + 1}...`,
                flyTo: false
            });

            geocoderStop.addTo(`#${stopId}`);

            // Add connector to previous step (either Start or Last Stop)
            if (currentId === 0) {
                // First stop - no connector needed from Start (it already has one)
            } else {
                // Add connector to previous stop
                const prevStopId = `stop-${currentId - 1}`;
                const prevStopDiv = document.getElementById(prevStopId);
                if (prevStopDiv && !prevStopDiv.querySelector('.timeline-connector')) {
                    prevStopDiv.appendChild(createModeSelector(`${currentId - 1}`));
                }
            }

            // Fix Z-Index issue on suggestion click
            // When clicking a suggestion, focus is lost, so :focus-within fails
            // We need to keep z-index high for a moment to allow click to register
            const container = document.getElementById(stopId);
            container.addEventListener('focusin', () => {
                container.classList.add('active-z');
            });
            container.addEventListener('focusout', () => {
                setTimeout(() => {
                    container.classList.remove('active-z');
                }, 200);
            });

            geocoderStop.on('result', (e) => {
                console.log(`Stop ${currentId} Selected:`, e.result);
                if (!stopData[currentId]) stopData[currentId] = {};
                stopData[currentId].coords = e.result.center;

                // Add Marker
                if (window.addMapMarker) {
                    window.addMapMarker(e.result.center[1], e.result.center[0], 'stop');
                }
            });

            geocoderStop.on('clear', () => {
                console.log(`Stop ${currentId} Cleared`);
                delete stopData[currentId];
            });
        });

        // 4. Handle Fly Button
        document.getElementById('start-flight-btn').addEventListener('click', () => {
            // Collect all stops
            const activeStops = [];
            for (let i = 0; i < stopCounter; i++) {
                if (stopData[i] && stopData[i].coords) {
                    // Get mode for this stop (the connector AFTER this stop)
                    const modeEl = document.getElementById(`mode-${i}`);
                    const mode = modeEl ? modeEl.value : 'flight';
                    activeStops.push({
                        coords: stopData[i].coords,
                        mode: mode
                    });
                }
            }

            // Validate: need at least Start + 1 Stop
            if (!startCoords) {
                alert('Please select a Start location!');
                return;
            }
            if (activeStops.length === 0) {
                alert('Please add at least one stop!');
                return;
            }

            // Get Start Mode (the connector from Start to first Stop)
            const startMode = document.getElementById('mode-start').value;

            // Build route: Start -> Stop1 -> Stop2 -> ... -> LastStop (destination)
            // Each point has the mode for traveling TO the NEXT point
            // Last point has no outgoing mode (it's the destination)
            const routePoints = [
                { coords: startCoords, mode: startMode }
            ];

            // Add all stops except the last one with their modes
            for (let i = 0; i < activeStops.length - 1; i++) {
                routePoints.push({
                    coords: activeStops[i].coords,
                    mode: activeStops[i].mode
                });
            }

            // Add last stop as destination (no outgoing mode)
            const lastStop = activeStops[activeStops.length - 1];
            routePoints.push({
                coords: lastStop.coords,
                mode: null
            });

            // Store for export functionality
            window.lastStopCoords = lastStop.coords;

            // Convert to (lat, lng) expected by newApp logic
            const formattedRoute = routePoints.map(p => ({
                lat: p.coords[1],
                lng: p.coords[0],
                mode: p.mode
            }));

            if (window.updateFlight) {
                window.updateFlight(formattedRoute);
            } else {
                alert('Flight system not loaded yet. Please wait and try again.');
            }
        });
    </script>
</body>

</html>